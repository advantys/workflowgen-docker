trigger:
  branches:
    include:
      - master

jobs:
  - job: Buildltsc2016
    displayName: Build WorkflowGen's Images (ltsc2016)
    pool:
      name: Docker
      demands: Container.Windows.Version -equals ltsc2016
    strategy:
      matrix:
        7.14:
          WFGEN_VERSION_FOLDER: 7.14
          WFGEN_VERSION: 7.14.5
          WINDOWS_SERVER_VERSION: ltsc2016
    steps:
      - powershell: |
          $buildPath = [io.path]::Combine(
            $env:BUILD_REPOSITORY_LOCALPATH,
            $env:WFGEN_VERSION_FOLDER,
            'windows',
            'windowsservercore-{0}' -f $env:WINDOWS_SERVER_VERSION
          )
          $onbuildPath = Join-Path $buildPath 'onbuild'
          $imageName = 'advantys/workflowgen'
          $tag = '{0}-{1}' -f $env:WFGEN_VERSION, $env:WINDOWS_SERVER_VERSION
          $completeTag = '{0}:{1}' -f $imageName, $tag
          $onbuildTag = '{0}:{1}-onbuild' -f $imageName, $tag

          docker build -t $completeTag $buildPath
          docker build -t $onbuildTag $onbuildPath
  - job: Buildltsc2019
    displayName: Build WorkflowGen's Images (ltsc2019)
    pool:
      name: Docker
      demands: Container.Windows.Version -equals ltsc2019
    strategy:
      matrix:
        7.14:
          WFGEN_VERSION_FOLDER: 7.14
          WFGEN_VERSION: 7.14.5
          WINDOWS_SERVER_VERSION: ltsc2019
    steps:
      - powershell: |
          $buildPath = [io.path]::Combine(
            $env:BUILD_REPOSITORY_LOCALPATH,
            $env:WFGEN_VERSION_FOLDER,
            'windows',
            'windowsservercore-{0}' -f $env:WINDOWS_SERVER_VERSION
          )
          $onbuildPath = Join-Path $buildPath 'onbuild'
          $imageName = 'advantys/workflowgen'
          $tag = '{0}-{1}' -f $env:WFGEN_VERSION, $env:WINDOWS_SERVER_VERSION
          $completeTag = '{0}:{1}' -f $imageName, $tag
          $onbuildTag = '{0}:{1}-onbuild' -f $imageName, $tag

          docker build -t $completeTag $buildPath
          docker build -t $onbuildTag $onbuildPath
